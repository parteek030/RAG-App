<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF RAG Web App</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f2f2f2; }
    h1 { color: #333; }
    input, button, textarea { margin: 10px 0; padding: 8px; width: 100%; box-sizing: border-box; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    .output { margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    ul { padding-left: 20px; }
</style>
</head>
<body>

<h1>PDF RAG Web App</h1>

<h3>Step 1: Upload PDFs</h3>
<input type="file" id="pdfFiles" multiple accept=".pdf">
<ul id="selectedFilesList"></ul>
<button id="uploadBtn">Upload & Process PDFs</button>

<h3>Step 2: Query</h3>
<textarea id="queryText" rows="3" placeholder="Type your query here..." disabled></textarea>
<button id="queryBtn" disabled>Query</button>

<div class="output" id="output"></div>

<script>
const uploadBtn = document.getElementById("uploadBtn");
const queryBtn = document.getElementById("queryBtn");
const queryText = document.getElementById("queryText");
const pdfFiles = document.getElementById("pdfFiles");
const outputDiv = document.getElementById("output");
const selectedFilesList = document.getElementById("selectedFilesList");

// Array to store all selected PDFs
let accumulatedFiles = [];

// --- When user selects files ---
pdfFiles.addEventListener("change", (event) => {
    const newFiles = Array.from(event.target.files);

    // Add new files to accumulatedFiles, preventing duplicates
    newFiles.forEach(file => {
        if (!accumulatedFiles.some(f => f.name === file.name && f.size === file.size)) {
            accumulatedFiles.push(file);
        }
    });

    // Update the displayed list
    renderSelectedFiles();
});

// --- Function to render selected files ---
function renderSelectedFiles() {
    selectedFilesList.innerHTML = "";
    accumulatedFiles.forEach(file => {
        const li = document.createElement("li");
        li.textContent = file.name;
        selectedFilesList.appendChild(li);
    });
}

// --- Upload PDFs ---
uploadBtn.addEventListener("click", async () => {
    if (accumulatedFiles.length === 0) {
        alert("Please select PDF files to upload.");
        return;
    }

    const formData = new FormData();
    accumulatedFiles.forEach(file => formData.append("files", file));

    outputDiv.innerHTML = "Uploading and processing PDFs...";

    try {
        const response = await fetch("/upload-multiple", {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        if (response.ok) {
            outputDiv.innerHTML = `<b>Files processed:</b> ${data.files.join(", ")}`;
            queryText.disabled = false;
            queryBtn.disabled = false;
            // Optionally clear accumulated files after upload:
            // accumulatedFiles = [];
            // renderSelectedFiles();
        } else {
            outputDiv.innerHTML = `<b>Error:</b> ${data.error}`;
        }
    } catch (err) {
        outputDiv.innerHTML = `<b>Error:</b> ${err}`;
    }
});

// --- Query RAG ---
queryBtn.addEventListener("click", async () => {
    const query = queryText.value.trim();
    if (!query) {
        alert("Please enter a query.");
        return;
    }

    outputDiv.innerHTML = "Querying...";

    try {
        const response = await fetch("/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: query })
        });

        const data = await response.json();

        if (response.ok) {
            let sourcesText = "N/A";
            if (Array.isArray(data.Sources) && data.Sources.length > 0) {
                sourcesText = data.Sources.map(src => {
                    const keys = Object.keys(src).filter(k => k.toLowerCase() !== "text" && k.toLowerCase() !== "content");
                    const mainInfo = keys.map(k => `${k}: ${src[k]}`).join(", ");
                    let contentPreview = "";
                    if (src.text) contentPreview = src.text.slice(0, 100) + "...";
                    else if (src.content) contentPreview = src.content.slice(0, 100) + "...";
                    return mainInfo ? `${mainInfo} â€” ${contentPreview}` : contentPreview;
                }).join("<br>");
            }

            outputDiv.innerHTML = `
                <b>Answer:</b> ${data.Answer || "N/A"}<br>
                <b>Sources:</b><br> ${sourcesText}<br>
                <b>Confidence:</b> ${data.Confidence || "N/A"}
            `;
        } else {
            outputDiv.innerHTML = `<b>Error:</b> ${data.error}`;
        }
    } catch (err) {
        outputDiv.innerHTML = `<b>Error:</b> ${err}`;
    }
});
</script>

</body>
</html>
